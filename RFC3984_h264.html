RTP Payload Format for H.264 Video

[RFC3984](https://www.ietf.org/rfc/rfc3984.txt)

## 1.3 NALU Type

Network Abstraction Layer Unit Type: 有关NAL设计的教程信息，参见[12]、[13]和[14]。所有NAL单元均由单个NAL单元类型8位字节组成，该8位字节还共同充当此RTP有效负载格式的有效负载头。NAL单元的有效负载在随后出现。

[1]中指定了NAL单元类型八位位组的语法和语义，但以下总结了NAL单元类型八位位组的基本属性。 NAL单元类型八位字节具有以下格式：

```c
      +---------------+
      |0|1|2|3|4|5|6|7|
      +-+-+-+-+-+-+-+-+
      |F|NRI|  Type   |
      +---------------+
```

F: 1 bit,  forbidden_zero_bit。H264规范声明值1为违反语法。

NRI: 2 bits,  nal_ref_idc。值00表示NAL单元的内容未用于重建参考图片以进行图片间预测。 可以丢弃这样的NAL单元而不会冒险参考图片的完整性。 大于00的值表示需要NAL单元的解码才能保持参考图片的完整性。

Type: 5 bits,  nal_unit_type。该组件指定NAL单元有效载荷类型，如[1]的表7-1中所定义，并且在本备忘录的后面。 有关所有当前定义的NAL单元类型及其语义的参考，请参阅[1]中的7.4.1节。

本备忘录介绍了新的NAL单元类型，将在5.2节中介绍。 在此备忘录中定义的NAL单元类型在[1]中标记为未指定。 此外，此规范扩展了F和NRI的语义，如5.3节所述。

# 3.范围

该有效负载规范只能用于通过RTP承载“naked” H.264 NAL单元流(nal单元裸流)，而不能用于H.264附件B中讨论的比特流格式。 该规范的第一个应用可能是在会话多媒体领域，视频电话或视频会议中，但是有效载荷格式还涵盖了其他应用，例如Internet流和IP电视。

# 4.定义和缩写

## 4.1 定义

本文档使用[1]的定义。 为方便起见，总结了[1]中定义的以下术语：

access unit：存取单元，一组NAL单元始终包含主编码图片。除了主要编码图片之外，访问单元还可包含一个或多个冗余编码图片或不包含编码图片的切片或切片数据分区的其他NAL单元。访问单元的解码总是产生解码的图片。

coded video sequence：编码视频序列，一系列访问单元，按照解码顺序，由一个瞬时解码刷新（IDR）访问单元组成，后跟0个或多个非IDR访问单元，包括所有后续访问单元，但不包括任何后续IDR访问单元。

IDR picture：仅包含具有I或SI切片类型的切片的编码图片，在解码过程中会导致“重置”。在IDR图片的解码之后，可以按照解码顺序对所有随后的编码图片进行解码，而无需根据在IDR图片之前解码的任何图片进行帧间预测。

Primary coded picture: 主要编码图片，解码过程将使用的图片的编码表示形式，用于符合H.264的比特流。主编码图片包含图片的所有宏块。

Redundant coded picture: 冗余编码图片，图片或图片的一部分的编码表示。对于符合H.264的比特流，解码过程不得使用冗余编码图像的内容。冗余编码图片的内容可以由解码过程用于包含错误或丢失的比特流。

VCL NAL unit: 用于指代切片和编码数据分区NAL单元的统称。

此外，以下定义适用：

decoding order number(DON): 有效负载结构中的字段，或表示NAL单元解码顺序的派生变量。DON的值在0到65535之间（包括0和65535）。达到最大值后，DON的值回绕为0.

NAL unit decoding order：符合[1]中7.4.1.2节中给出的NAL单元顺序约束的NAL单元顺序。

transmission order（传输顺序）：以RTP序列号升序排列的数据包顺序（以模算术方式）。在聚合分组内，NAL单元的传输顺序与分组中的NAL单元的出现顺序相同。

media aware network element（MANE）：媒体感知网络元素；一个网络元素，例如中间盒或应用程序层网关，它能够解析RTP有效负载标头或RTP有效负载的某些方面并对内容做出反应。

​		注释：MANE的概念超越了普通路由器或网关，因为MANE必须了解信令（例如，了解媒体流的有效负载类型映射），并且在使用SRTP时必须被信任。使用MANE的优点是，它们允许根据媒体编码的需要丢弃数据包。例如，如果MANE由于某个链路上的拥塞而不得不丢弃数据包，则它可以识别那些丢弃对用户体验的负面影响最小的数据包，并将其删除以消除拥塞 and/or 将延迟保持在较低水平。

缩略语：

DON：  Decoding Order Number

DONB:   Decoding Order Number Base

DOND:   Decoding Order Number Difference

FEC:       Forward Error Correction. 前向纠错

FU:         Fragmentation Unit. 碎片单元

IDR:        Instantaneous Decoding Refresh. 即使解码刷新

IEC:        International Electrotechnical Commission. 国际电工委员会

ISO:        International Organization for Standardization. 国际标准化组织

ITU-T:     International Telecommunication Union, Telecommunication Standardization Sector. 国际电信联盟，电信标准化部门

MANE:    Media Aware Network Element. 媒体感知网络元素

MTAP:     Multi-Time Aggregation Packet. 聚合保报文

MTAP16: MTAP with 16-bit timestamp offset

MTAP24: MTAP with 24-bit timestamp offset

NAL:        Network Abstraction Layer. 网络抽象层

NALU:     NAL Unit. NAL单元

SEI:         Supplemental Enhancement Information. 补充增强信息

STAP:      Single-Time Aggregation Packet. 一次性聚合报文

STAP-A:  STAP type A

STAP-B:  STAP type B

TS:           Timestamp

VCL:         Video Coding Layer. 视频编码层

# 5. RTP Payload Format

## 5.1 RTP Header 用法

RTP标头的格式在RFC 3550 [4]中指定，为方便起见在图1中重新打印。 此有效载荷格式以与该规范一致的方式使用标头的字段。

当每个RTP数据包封装一个NAL单元时，建议的RTP有效负载格式在5.6节中指定。聚合数据包盒分段单元的RTP有效负载（以及一些RTP标头位的设置）分别在5.7和5.8节中指定。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |V=2|P|X|  CC   |M|     PT      |       sequence number         |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                           timestamp                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |           synchronization source (SSRC) identifier            |
      +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
      |            contributing source (CSRC) identifiers             |
      |                             ....                              |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

​               图1. RTP header according to RFC 3550

根据该RTP有效载荷格式设置的RTP头信息设置如下：

Marker bit （M）：1 bit

​     根据视频格式中M位的正常使用情况，为RTP时间戳指示的访问单元的最后一个数据包进行设置，以实现高效的播放缓冲区处理。对于聚合分组（STAP和MTAP），RTP报头中的标记位必须设置如果聚合分组在其自己的RTP分组中传输时，该聚合分组的最后NAL单元标记位。解码器可以使用该位作为访问单元最后一个分组的早期指示，但不得依赖于该属性。

​        注释：仅一个M bit与携带多个NAL单元的聚合分组相关联。因此，如果网关已将聚合数据包重新打包为几个数据包，则它无法可靠地设置这些数据包的M位。

Payload type（PT）： 7 bits

​	 对于这种新的数据包格式，RTP有效负载类型的分配超出了本文档的范围，此处不再赘述。 有效负载类型的分配必须通过使用的配置文件或以动态方式执行。

Sequence number（SN）：16 bits

​     根据RFC 3550进行设置和使用。对于单个NALU和非交织打包模式，序列号用于确定NALU的解码顺序。

Timestamp： 32 bits

​     RTP时间戳设置为内容的采样时间戳。 必须使用90 kHz时钟速率。

如果NAL单元不具有其自身的定时属性（例如，参数集和SEI NAL单元），则将RTP时间戳设置为包括NAL单元的访问单元的主要编码图片的RTP时间戳。7.4.1.2节。

MTAP的RTP时间戳的设置在5.7.2节中定义。

接收方应忽略仅具有一个显示时间戳的访问单元中包括的任何图像定时SEI消息。 相反，接收者应该使用RTP时间戳来同步显示过程。

对于不应该显示为多个字段的图片，RTP发送者不应发送图片定时SEI消息。

如果一个接入单元在一个图像定时SEI消息中带有一个以上的显示时间戳，则应将SEI消息中的信息视为相对于RTP时间戳，最早的事件发生在RTP时间戳给出的时间，并且 SEI消息图片时序值的差异给出了后续事件。令tSEI1，tSEI2，...，tSEIn为访问单元的SEI消息中携带的显示时间戳，其中tSEI1是所有此类时间戳中最早的时间戳。 令tmadjst()为一个将SEI消息时标调整为90 kHz时标的函数。令TS为RTP时间戳。然后，与tSEI1相关的事件的显示时间为TS。 使用tSEIx的事件的显示时间（其中x为[2..n]）为TS + tmadjst（tSEIx-tSEI1）。

​       注释：在称为3：2下拉的操作中，通常需要将编码帧显示为字段，在该操作中，使用隔行扫描在显示器上显示由编码帧组成的电影内容。图片定时SEI消息可为同一编码图片传送多个时间戳，因此可以完美地控制3：2下拉过程。 图片定时SEI消息机制是必需的，因为RTP时间戳中每个编码帧只能传递一个时间戳。

​       注释：由于H.264允许解码顺序与显示顺序不同，因此RTP时间戳的值可能不会随RTP序列号而单调非递减。此外，RTCP报告中报告的到达间隔抖动的值可能不是网络性能的可靠指标，因为到达间隔抖动的计算规则（RFC3550的6.4.1节）假定数据包的RTP时间戳直接成比例传输时间。

## 5.2 RTP有效负载格式的通用结构

有效载荷格式定义了三种不同的基本有效载荷结构。 接收器可以通过RTP有效负载的第一个字节来识别有效负载结构，该字节同时充当RTP有效负载头，在某些情况下，还充当有效负载的第一个字节。 该字节始终被构造为NAL单元标头。 NAL单元类型字段指示存在哪种结构。 可能的结构如下：

单个NAL单位数据包：仅在有效载荷中包含单个NAL单元。NAL标头类型字段将等于原始NAL单元类型；即介于1到23之间（含1和23）。在5.6节中指定。

聚合分组：用于将多个NAL单元聚合为单个RTP有效负载的分组类型。此数据包有4个版本，分别是A型一次性聚合数据包（STAP-A），B型一次性聚合数据包（STAP-B），具有16位偏移量的多次聚合数据包（MTAP）（MTAP16）和具有24位偏移量的多时间聚合数据包（MTAP）（MTAP24）。分配给STAP-A，STAP-B，MTAP16盒MTAP24的NAL单元类型编号分别为24、25、26和27.在5.7节中指定。

分段单元：用于在多个RTP数据包上分段单个NAL单元。存在两个版本FU-A和FU-B，分别用NAL单元类型编号28和29标识。在第5.8节中指定。

```c
      Type   Packet    Type name                        Section
      ---------------------------------------------------------
      0      undefined                                    -
      1-23   NAL unit  Single NAL unit packet per H.264   5.6
      24     STAP-A    Single-time aggregation packet     5.7.1
      25     STAP-B    Single-time aggregation packet     5.7.1
      26     MTAP16    Multi-time aggregation packet      5.7.2
      27     MTAP24    Multi-time aggregation packet      5.7.2
      28     FU-A      Fragmentation unit                 5.8
      29     FU-B      Fragmentation unit                 5.8
      30-31  undefined                                    -
```

注释：本规范不限制单个NAL单元数据包和分段单元中封装的NAL单元的大小。封装在任何聚合数据包中的NAL单元的最大大小为65535字节。

## 5.3 NAL单元位组用法

```c
      +---------------+
      |0|1|2|3|4|5|6|7|
      +-+-+-+-+-+-+-+-+
      |F|NRI|  Type   |
      +---------------+
```

本节根据此规范指定F和NRI的语义。

F：1 bit，forbidden_zero_bit。0表示NAL单元类型和有效负载不应包含位错误或其他语法冲突。1表示NAL单元类型和有效负载可能包含误码或其他语法违规。MANE应该将F置为1，以指示NAL单元中检测到的位错误。H.264规范要求F位等于0.当F为1时，建议解码器在有效载荷或NAL单元类型中可能存在误码或任何其他语法冲突。对于其中F等于1的NAL单元，解码器最简单的反应是丢弃这种NAL单元，并将丢失的数据隐藏在丢弃的NAL单元中。

NRI：2 bits , nal_ref_idc。H264规范中，值00和非0值的语义保持不变。换句话说，值00指示NAL单元的内容不用于重构用于画面间预测的参考画面。可以丢弃这样的NAL单元而不会冒险参考图片的完整性。大于00的值表示需要NAL单元的解码才能保持参考图片的完整性。

除上述 规范外，根据此RTP有效负载规范，大于00的NRI值表示相对传输优先级，由编码器确定。MANE可以使用此信息来保护重要的NAL单元，而不是保护重要性较低的NAL单元。最高传输优先级是11，其次是10，然后是01；最后，00是最低的。

​	注释：NRI的任何非0值在H264解码器中均得到相同的处理。因此，当将NAL单元传递给解码器时，接收器无需操纵NRI的值。

当nal_unit_type的值在1到12（含）范围内时，H.264编码器必须根据H.264规范（7.4.1节）设置NRI的值。 特别是，H.264规范要求，对于nal_unit_type等于6、9、10、11或12的所有NAL单元，NRI的值应等于0。

对于nal_unit_type等于7或8的NAL单元（分别指示序列参数集或图片参数集），H.264编码器应将NRI的值设置为11（二进制格式）。 对于nal_unit_type等于5的主编码图像的编码切片NAL单元（指示属于IDR图像的编码切片），H.264编码器应将NRI的值设置为11（二进制格式）。

为了将剩余的nal_unit_types映射到NRI值，可以使用以下示例，并已证明该示例在特定环境中有效[13]。 根据应用程序和所使用的H.264 / AVC附件A配置文件，可能还需要其他映射。

   注释：某些配置文件中不提供数据分区；例如在出要或基准资料中。因此，只有当视频比特流符合允许数据分区的配置文件，而不是符合主要或基准配置文件的流时，最终单元类型2、3和4才会出现。

表2.基本编码参考图片的编码切片和编码切片数据分区的NRI值示例

```c
      NAL Unit Type     Content of NAL unit              NRI (binary)
      ----------------------------------------------------------------
       1              non-IDR coded slice                         10
       2              Coded slice data partition A                10
       3              Coded slice data partition B                01
       4              Coded slice data partition C                01
```

​                                              表2

注释：如前所述，非参考图片的NRI值是H264/AVC规定的00.

H264编码器应为冗余编码参考图片的编码切片和编码切片数据分区NAL单元设置NRI的值等于01。

NAL单元类型24至29（包括该值）的NRI值的定义在本备忘录的5.7和5.8节中给出。

对于nal_unit_type范围在13到23之间（含端点）的NAL单元，不建议使用NRI值，因为这些值是为ITU-T和ISO / IEC保留的。 对于nal_unit_type等于0或在30到31（含）之间的NAL单元，不建议使用NRI的值，因为在本备忘录中未指定这些值的语义。

## 5.4 打包模式

本备忘录指定了三种打包模式的情况：

- 单NAL单元模式
- Non-interleaved 非交错模式
- 交错模式

单个NAL单元模式的目标对象是符合ITU-T H241建议书[15]的会话系统（参见12.1节）。非交错模式适用于可能不符合ITU-T H241建议书的会话系统。非交错模式下，以NAL单元解码顺序发送NAL单元。交错模式适用于不需要非常低的端到端延迟的系统。交错模式允许传输NAL单元解码顺序以外的NAL单元。

使用中的打包模式可以通过可选的打包模式MIME参数的值或外部方式来发出信号。使用的分组模式控制RTP有效负载中允许使用的NAL单元类型。表3总结了没中打包模式所允许的NAL单元类型。一些NAL单元类型值（表3中未定义）保留用于将来的扩展。这些类型的NAL单元不应由发送方发送，而必须由接收方忽略。 例如，具有相关分组类型“ NAL单元”的类型1-23在“单NAL单元模式”和“非交错模式”中是允许的，但在“交错模式”中是不允许的。打包模式将在第6节中详细介绍。

表3.每种打包模式允许的NAL单元类型的摘要（是=允许，否=不允许，ig =忽略）

```c
      Type   Packet    Single NAL    Non-Interleaved    Interleaved
                       Unit Mode           Mode             Mode
      -------------------------------------------------------------

      0      undefined     ig               ig               ig
      1-23   NAL unit     yes              yes               no
      24     STAP-A        no              yes               no
      25     STAP-B        no               no              yes
      26     MTAP16        no               no              yes
      27     MTAP24        no               no              yes
      28     FU-A          no              yes              yes
      29     FU-B          no               no              yes
      30-31  undefined     ig               ig               ig
```

​                                           table 3

## 5.5 解码单号(DON)

在交错分组模式中，允许NAL单元的传输顺序不同于NAL单元的解码顺序。解码顺序号（DON）是有效负载结构中的字段或表示NAL单元解码顺序的派生变量。在第13节中给出了用于传输超出解码顺序和使用DON的原理和用例示例。

传输和解码顺序的耦合由OPTIONAL sprop-interleaving-depth MIME参数控制，如下所示。当可选的sprop-interleaving-depth MIME参数的值等于0（显示或默认）或通过外部手段禁止NAL单元传输超出其解码顺序时，NAL单元的传输顺序必须符合NAL单位解码顺序。当可选sprop-interleaving-depth MIME参数的值大于0或外部手段允许传输NAL单元超出其解码顺序时，

- MTAP16和MTAP24中的NAL单元的顺序不需要是NAL单元的解码顺序，并且
- 通过将两个连续数据包中的STAP-B，MTAP和FU解封装而生成的NAL单元的顺序不需要是NAL单元的解码顺序。

用于单个NAL单元数据包，STAP-A和FU-A的RTP有效负载结构不包括DON。STAP-B和FU-B结构包括DON，MTAPs的结构支持5.7.7.2节中指定的DON的派生。

   注释：当FU-A以交错模式出现时，它总是跟随FU-B，并设置DON。

   注释：如果发送方希望每个数据包封装单个NAL单元，并按其解码顺序发送数据包，则可以使用STAP-B数据包类型。

在单个NAL单元打包模式下，由RTP序列号确定的NAL单元的传输顺序必须与其NAL单元的解码顺序相同。在非交错模式打包下，单个NAL单元数据包中的NAL单元，STAP-As和FU-As的传输顺序必须与其NAL单元的解码顺序相同。STAP中的NAL单元必须出现在NAL中单元解码顺序。因此，首先通过STAP内的隐式顺序提供解码顺序，然后通过RTP序列号提供STAP，FU和单个NAL单元分组之间的顺序的解码顺序。

STAP-B，MTAP和以FU-B开头的一系列分段单元中携带的NAL单元的DON值的信令分别在第5.7.1、5.7.2和5.8节中指定。可以按传输顺序将第一个NAL单元的DON值设置为任何值。DON的值在0到65535（包括0和65535）。达到最大值后，DON的值回绕为0.

包含在任何STAP-B，MTAP或一系列以FU-B开头的分段单元中的两个NAL单元的解码顺序确定如下。假设DON（i）是在传输顺序中具有索引i的NAL单元的解码顺序号。函数don_diff(m, n)的指定如下：

```c
      If DON(m) == DON(n), don_diff(m,n) = 0

      If (DON(m) < DON(n) and DON(n) - DON(m) < 32768),
      don_diff(m,n) = DON(n) - DON(m)

      If (DON(m) > DON(n) and DON(m) - DON(n) >= 32768),
      don_diff(m,n) = 65536 - DON(m) + DON(n)

      If (DON(m) < DON(n) and DON(n) - DON(m) >= 32768),
      don_diff(m,n) = - (DON(m) + 65536 - DON(n))

      If (DON(m) > DON(n) and DON(m) - DON(n) < 32768),
      don_diff(m,n) = - (DON(m) - DON(n))
```

Don_diff(m, n)的正值表示在解码顺序中，具有传输顺序索引n的NAL单元遵循具有传输顺序索引m的NAL单元。当don_diff(m, n)等于0时，则两个NAL单元的NAL单元解码顺序可以是任意顺序。don_diff(m, n)的负值表示在解码顺序中，具有传输顺序索引n的NAL单元在具有传输顺序索引m的NAL单元之前。

DON相关字段的值（DON，DONB和DOND；参见5.7节）必须确保由DON的值确定的解码顺序（如上所述）符合NAL单元的解码顺序。如果按NAL单元解码顺序切换两个NAL单元的顺序，并且新顺序不符合NAL单元解码顺序，则NAL单元不得具有相同的DON值。如果切换了NAL单元流中两个连续NAL单元的顺序，而新顺序仍符合NAL单元解码顺序，则NAL单元的DON值可能相同。例如，当使用中的视频编码配置文件允许任意切片顺序时，编码图片的所有编码切片NAL单元被允许具有相同的DON值。因此，具有相同DON值的NAL单元可以以任何顺序被解码，并且具有不同DON值的两个NAL单元应当以上面指定的顺序被传递到解码器。当按NAL单元解码顺序的两个连续NAL单元具有不同的DON值时，按解码顺序的第二个NAL单元的DON值应为第一个NAL的值，并增加一个。

在第7节中给出了恢复NAL单元解码顺序的解封装过程的示例。

   注释：即使在无差错传输中，接收器页不应该期望两个连续NAL单元的DON的绝对值按NAL单元的解码顺序等于1。不需要增加1，因为在将DON的值与NAL单元关联时，可能不知道是否所有NAL单元都已交付给接收器。例如，当分组被转发到的网络中的比特率不足时，网关可能不转发非参考图片的编码的切片NAL单元或SEI NAL单元。在另一个示例中，实时广播不时被诸如广告之类的预编码内容打断。预先发送预编码剪辑的第一帧内图片，以确保它在接收器中随时可用。当发送第一帧内图片时，始发者在解码顺序跟随预编码剪辑的第一帧内图片之前，不完全知道将要编码多少个NAL单元。因此，在发送预编码剪辑的第一帧内图片的NAL单元时，DON的值必须被估计，并且DON的值可能出现间隙。

## 5.6 单个NAL单元数据包

此处定义的单个NAL单元数据包务必仅包含[1]中定义的类型的NAL单元。这意味着在单个NAL单元分组内不能使用聚合分组或分段单元。通过以RTP序列号顺序解封装单个NAL单元数据包组成的NAL单元流务必符合NAL单元解码顺序。单个NAL单元数据包的结构如图2所示。

   注释：NAL单元的第一个字节用作RTP有效负载头。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |F|NRI|  type   |                                               |
      +-+-+-+-+-+-+-+-+                                               |
      |                                                               |
      |               Bytes 2..n of a Single NAL unit                 |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

​                   图2.RTP payload format for single NAL unit packet

## 5.7 汇聚封包

聚合数据包是此有效负载规范的NAL单元聚合方案。引入该方案以反映两个关键目标网络的极大不同的MTU大小：有线IP网络（MTU大小通常受以太网MTU大小限制；大约1500字节），以及IP或非IP（例如ITU）-T H324/M的无线通信系统，其首选传输单元大小为254字节或更小。为了防止两个世界之间的媒体转码，并且避免不希望的分组开销，引入了NAL单元聚合方案。

本规范定义了两种类型的聚合包：

- 一次性聚合数据包（STAP）：聚合具有相同NALU事件的NAL单元。定义了两种类型的STAP，一种不包括DON（STAP-A），另一种包括DON（STAP-B）。
- 多时间聚合数据包（MTAP）：聚合NALU事件可能不同的NAL单元。定义了两个不同的MTAP，其NAL单位时间戳偏移的长度不同。

术语NALU-time被定义为如果该NAL单元将在其自己的RTP分组中传输的话，RTP时间戳将具有的值。

聚合分组中携带的每个NAL单元被封装在聚合单元中。请参阅下面的四种不同的聚合单元及其特征。

聚合数据包的RTP有效负载格式的结构如图3所示。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |F|NRI|  type   |                                               |
      +-+-+-+-+-+-+-+-+                                               |
      |                                                               |
      |             one or more aggregation units                     |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

​             图3. RTP payload format for aggregation packets

MTAPs和STAPs共享以下打包规则：必须将RTP时间戳设置为要汇总的所有NAL单元中NALU事件的最早时间。NAL单元类型八位位组的类型字段必须设置为适当的值，如表4所示。如果聚合的NAL单元的所有F位均为0，则必须清除F位；否则，必须设置它。NRI的值必须是聚合分组中所有NAL单元中的最大值。

```c
      Type   Packet    Timestamp offset   DON related fields
                       field length       (DON, DONB, DOND)
                       (in bits)          present
      --------------------------------------------------------
      24     STAP-A       0                 no
      25     STAP-B       0                 yes
      26     MTAP16      16                 yes
      27     MTAP24      24                 yes
```

   table 4.     Type field for STAPs and MTAPs

如果将RTP标头中的标记位传输到自己的RTP数据包中，则将其设置为该聚合数据包的最后NAL单元的标记位所具有的值。

聚合数据包的有效载荷由一个或多个聚合单元组成。有关四种不同类型的聚合单元，请参见第5.7.1节和第5.7.2节。聚合报文可以携带尽可能多的聚合单元；但是，聚合数据包中的数据总量显然必须适合IP数据包，并且应该选择大小，以使最终的IP数据包小于MTU大小。汇聚包不得包含第5.8节中指定的分段单元。聚合数据包不得嵌套；即，一个聚合数据包一定不能包含另一个聚合数据包。

### 5.7.1 一次性聚合报文

Single-time aggregation packet（STAP）：一次性聚合数据包，只要汇总了共享相同NALU时间的NAL单元，就应该使用STAP。如图4所示，STAP-A的有效载荷不包含DON，并且至少由一个单次聚合单元组成。STAP-B的有效载荷由16位无符号解码顺序号（DON）组成（按网络字节顺序），其后是至少一个单次聚合单元，如图5所示。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      :                                               |
      +-+-+-+-+-+-+-+-+                                               |
      |                                                               |
      |                single-time aggregation units                  |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

​             图4.payload format for STAP-A

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      :  decoding order number (DON)  |               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
      |                                                               |
      |                single-time aggregation units                  |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

​           图5. payload format for STAP-B

DON字段按传输顺序为STAP-B中的第一个NAL单元指定DON的值。对于STAP-B中按出现顺序的每个连续NAL单元，DON的值等于（STAP-B中前一个NAL单元的DON的值+1）%65536，其中‘%’代表取模运算。

一次性聚合单元由16位无符号大小信息（以网络字节顺序）组成，该信息指示以字节为单位的后续NAL单元的大小（不包括这两个八位字节，但包括NAL单元的NAL单元类型八位字节），后跟NAL单元本身，包括其NAL单元类型字节。一次性聚合单元在RTP有效负载内按字节对齐，但可能未在32位字边界上对齐。图6展示了一次性聚合单元的结构。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      :        NAL unit size          |               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
      |                                                               |
      |                           NAL unit                            |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

​     图6. structure for single-time aggregation unit

图7 给出了一个包含STAP-A的RTP数据包的示例。STAP包含两个单时间聚合单元，在图中分别标记为1和2.

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          RTP Header                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |STAP-A NAL HDR |         NALU 1 Size           | NALU 1 HDR    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         NALU 1 Data                           |
      :                                                               :
      +               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |               | NALU 2 Size                   | NALU 2 HDR    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                         NALU 2 Data                           |
      :                                                               :
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

   图7. an example of RTP packet including an STAP-A and two single-time aggregation units

图8给出了一个包含STAP-B的RTP数据包的示例。STAP包含两个单时间聚合单元，在图中分别标记为1和2.

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          RTP Header                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |STAP-B NAL HDR | DON                           | NALU 1 Size   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      | NALU 1 Size   | NALU 1 HDR    | NALU 1 Data                   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
      :                                                               :
      +               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |               | NALU 2 Size                   | NALU 2 HDR    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                       NALU 2 Data                             |
      :                                                               :
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

   图8. An example of an RTP packet including an STAP-B and two single-time aggregation units

### 5.7.2 多次聚合数据包（MTAP）

MTAP的NAL单元有效载荷包括一个16位无符号解码阶数基（DONB）（按网络字节顺序）和一个或多个多时间聚合单元，如图9所示。DONB必须包含DON的值，用于MTAP的NAL单元中的NAL单元解码顺序中的第一NAL单元。

​    注释：NAL单元解码顺序中的第一NAL单元不一定是将NAL单元封装在MTAP中的顺序中的一个NAL单元。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      :  decoding order number base   |               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
      |                                                               |
      |                 multi-time aggregation units                  |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图9. NAL unit payload format for MTAPs

在本规范中定义了两个不同的多时间聚合单元。它们都由以下NAL单元的16位无符号大小信息（以网络字节顺序），8位无符号解码顺序号差（DOND）和n位（以网络字节顺序）时间戳偏移量（TS offset）组成。对于此NAL单元，其中n可以为16或24.在不同的MTAP类型（MTAP16盒MTAP24）之间进行选择取决于应用程序：时间戳偏移量越大，MTAP的灵活性就越高，但是开销也就越高。

MTAP16盒MTAP24的多说几件聚合单元的结构分别显示在图10和11中。数据包内聚合单元的开始或结束位置不需要在32位字节边界上。后面的NAL单元的DON等于（DONB+DOND）%65536，其中%表示模运算。该备忘录未指定如何对MTAP中的NAL单元进行排序，但在大多数情况下，应使用NAL单元解码顺序。

时间戳偏移字段必须设置为等于一下公式的值：如果NALU-time大于或等于数据包的RTP时间戳，则时间戳偏移等于（NAL的NALU-time 单元-数据包的RTP时间戳）。如果NALU时间小于分组的RTP时间戳，则时间戳偏移等于NALU时间+（2 ^ 32-分组的RTP时间戳）。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      :        NAL unit size          |      DOND     |  TS offset    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  TS offset    |                                               |
      +-+-+-+-+-+-+-+-+              NAL unit                         |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

​        图10. Multi-time aggregation unit for MTAP16

``` c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      :        NALU unit size         |      DOND     |  TS offset    |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |         TS offset             |                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
      |                              NAL unit                         |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

​       图11。 Multi-time aggregation unit for MTAP24

对于MTAP中“最早的”多时间聚合单元，时间戳偏移量必须为0.因此，MTAP本身的RTP时间戳与最早的NALU时间相同。

​    注释：如果聚合单元封装在单个NAL单元数据包中，则“最早的”多时间聚合单元是MTAP所有聚合单元中扩展RTP时间戳最小的单元。扩展时间戳是一种具有32位以上的时间戳，能够对时间戳字段的环绕进行计数，因此，如果时间戳环绕，则可以确定最小值。按照将聚合单元封装在MTAP中的顺序，此类“最早的”聚合单元可能不是第一个。“最早的”NAL单元也不必与NAL单元解码顺序中的第一NAL单元相同。

图12给出了一个RTP数据包的示例，其中包含MTAP16类型的多时间聚合数据包，该数据包包含两个多时间聚合单元，在图中标记为1和2.

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          RTP Header                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |MTAP16 NAL HDR |  decoding order number base   | NALU 1 Size   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  NALU 1 Size  |  NALU 1 DOND  |       NALU 1 TS offset        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  NALU 1 HDR   |  NALU 1 DATA                                  |
      +-+-+-+-+-+-+-+-+                                               +
      :                                                               :
      +               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |               | NALU 2 SIZE                   |  NALU 2 DOND  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |       NALU 2 TS offset        |  NALU 2 HDR   |  NALU 2 DATA  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+               |
      :                                                               :
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图12. An RTP packet including a multi-time aggregation packet of type MTAP16 and two multi-time aggregation units

图13给出了一个RTP数据包的示例，其中包含MTAP24类型的多时间聚合数据包，该数据包包含两个多时间聚合单元（在图中标记为1和2）。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                          RTP Header                           |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |MTAP24 NAL HDR |  decoding order number base   | NALU 1 Size   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  NALU 1 Size  |  NALU 1 DOND  |       NALU 1 TS offs          |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |NALU 1 TS offs |  NALU 1 HDR   |  NALU 1 DATA                  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
      :                                                               :
      +               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |               | NALU 2 SIZE                   |  NALU 2 DOND  |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |       NALU 2 TS offset                        |  NALU 2 HDR   |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |  NALU 2 DATA                                                  |
      :                                                               :
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

 图13. An RTP packet including a multi-time aggregation packet of type MTAP24 and two multi-time aggregation units

## 5.8 Fragmentation Units(FUs)

这种有效负载类型允许将NAL单元分段为几个RTP数据包。在应用层上这样做而不是依赖于较低层的碎片（例如，通过IP）具有以下优点：

- 有效负载格式能够通过预记录视频中可能存在的IPv4网络传输大于64KB的NAL单元，特别是在高清晰度格式中（每张图片的切片数量有限制，这导致了限制）每张图片的NAL单元数，可能会导致NAL单元数量变大）。
- **分段机制允许分段单个图片并应用通过前向纠错，如12.5节所述。**

分段仅针对单个NAL单元定义，而不针对任何聚合数据包定义。NAL单元的片段由该NAL单元的整数个连续八位位组组成。NAL单元的每个八位位组必须恰好是该NAL单元一个片段的一部分。相同NAL单元的片段必须以连续的顺序发送，且RTP序列号递增（在第一个片段与最后一个片段之间不发送相同RTP包流中的其他RTP包）。同样，必须以RTP序列号顺序重新组合NAL单元。

当NAL单元被分段并在分段单元（FU）内传送时，其被称为分段NAL单元。STAP和MTAP绝对不能零碎。FU绝对不能嵌套；即一个FU一定不能包含另一个FU。

携带FU的RTP分组的RTP时间戳被设置为分段NAL单元的NALU时间。

图14给出了FU-As的RTP有效载荷格式。FU-A由一个八位字节的分段单元指示符，一个八位字节的分段单元头和分段单元有效负载组成。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      | FU indicator  |   FU header   |                               |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
      |                                                               |
      |                         FU payload                            |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

   图14. RTP payload format for FU-A

图15展示了FU-B的RTP有效载荷格式。FU-B由一个八位字节的分段单元指示符，一个八位字节的分段单元头，解码顺序号（DON）（按网络字节序）和分段单元有效载荷组成。换句话说，FU-B的结构与FU-A的结构相同，除了附加的DON场。

```c
       0                   1                   2                   3
       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      | FU indicator  |   FU header   |               DON             |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-|
      |                                                               |
      |                         FU payload                            |
      |                                                               |
      |                               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      |                               :...OPTIONAL RTP padding        |
      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

图15. RTP payload format for FU-B

NAL单元类型FU-B必须在交错式打包模式中用于分段式NAL单元的第一个分段单元。在任何其他情况下都不得使用FU-B型NAL单元。换句话说，在交错分组模式中，每个被分段的NALU具有FU-B作为第一片段，随后是一个或多个FU-A片段。

FU指示符字节具有以下格式：

```c
      +---------------+
      |0|1|2|3|4|5|6|7|
      +-+-+-+-+-+-+-+-+
      |S|E|R|  Type   |
      +---------------+
```

S： 1 bit

   设置为1时，“开始”位指示片段式NAL单元的开始。当随后的FU有效负载不是分段式NAL单元有效负载的开始时，“开始”位设置为0.

E：1 bit

   当设置为1时，“结束”位指示分段的NAL单元的末尾，即有效载荷的最后一个字节也是分段的NAL单元的最后一个字节。当随后的FU有效载荷不是分段NAL单元的最后一个分段时，则将End位设置为零。

R：1 bit

   保留位必须等于0，并且必须被接收机忽略。

Type：5 bits

   [1]的表7-1中定义的NAL单元有效负载类型。

如5.5节所述选择FU-B中的DON的值。

​      注释：FU-Bs中的DON字段允许网关将NAL单元分段为FU-B，而无需按照NAL单元的解码顺序组织传入的NAL单元。

片段化的NAL单元不得在一个FU中传输；也就是说，在同一FU标头中，不得将起始位和结束位都设置为1.

FU有效载荷由分段的NAL单元的有效载荷的片段组成，使得如果连续地连接连续FU的分段单元的有效载荷，则可以重构分段的NAL单元的有效载荷。分段的NAL单元的NAL单元类型字节不包括在分段单元有效载荷中，而是将分段的NAL单元的NAL单元类型字节的信息传递到分段指示符的F指示符字节的F和NRI字段中。分段单元和FU标头的类型字段中。UF有效载荷可以具有任意数量的八位位组，并且可以为空。

​    注释：在几乎无损的环境中，允许空FU减少特定类别的发送方的延迟。这些发送者的特征在于，它们在完全生成NALU之前并因此在知道NALU大小之前将NALU片段打包。如果不允许长度为0的NALU片段，则发送方必须先生成后续片段的至少一位数据，然后才能发送当前片段。由于H264的特性，有时几个宏块占据0位，这是不希望的，并且会增加延迟。但是应谨慎权衡0长度NALU的（潜在）使用情况，以防止由于传输额外的数据包而导致NALU丢失的风险增加。

如果碎片单元丢失，则接收方应按与相同的碎片NAL单元对应的传输顺序丢弃所有后续的碎片单元。

端点或MANE中的接收者可以将NAL单元的前n-1个片段聚合到一个（不完整的）NAL单元中，即使未接收到NAL单元的片段n。在这种情况下，必须将NAL单元的forbidden_zero_bit设置为1，以指示语法违规。

#6. 打包规则

打包模式在5.2节中介绍。在第6.1节中指定了不止一种打包模式所共有的打包规则。单个NAL单元模式，非交错模式和交错模式的打包规则分别在6.2、6.3和6.4节中指定。

## 6.1 通用打包规则

无论使用哪种打包模式，所有发送者都必须执行以下打包规则：

- 属于相同编码图像（并因此共享相同RTP时间戳值）的编码条带NAL单元或编码条带数据分区NAL单元可以按[1]中定义的适用配置文件允许的任何顺序发送；但是，对于延迟关键的系统，应按原始编码顺序发送，以最大程度地减少延迟。注意，编码顺序不一定是扫描顺序，而是NAL数据包可用于RTP堆栈的顺序。
- 根据第8.4节中给出的规则和建议处理参数集
- MANE不得复制除序列或图片参数集NAL单元以外的任何NAL单元，因为本备忘录和H264规范均未提供识别重复的NAL单元的手段。序列和图像参数集NAL单元可能会被复制，以使其正确接收的可能性更高，但是任何此类复制都不得影响任何活动序列或图像参数集的内容。复制应该在应用层执行，而不是复制RTP数据包（具有相同的序号）。

使用非交错模式和交错模式的发送者必须执行以下打包规则：

- MANE可以在RTP转换器中将单个NAL单元数据包转换为一个聚合数据包，将一个聚合数据包转换为多个单个NAL单位数据包，或将两种概念混合在一起。RTP转换器应至少考虑一下参数：路径MTU大小，不平等的保护机制（例如，通过根据RFC2733[18]的基于分组的FEC，尤其是对于序列和图片参数集NAL单元和编码切片数据分区）NAL单元），系统可承受的延迟以及接收器的缓冲能力。

​     说明： 根据RFC3550，需要RTP转换器处理RTCP。

## 6.2 单NAL单元模式

当OPTIONAL打包模式MIME参数的值等于0，不存在打包模式或未通过外部手段发出其他打包模式信号时，将使用此模式。所有接收器必须支持此模式。它主要用于与ITU-T H241建议书[15]的系统兼容的低延迟应用（参见12.1节）在这种模式下只能使用单个NAL单位数据包。切勿使用STAP，MTAP和FU。单个NAL单元数据包的传输顺序必须符合NAL单元解码顺序。

## 6.3 非交错模式

当OPTIONAL打包模式MIME参数的值等于1或通过外部方式打开该模式时，将使用此模式。应该支持该模式。它主要用于低延迟应用。在这种模式下，只能使用单个NAL单元数据包，STAP-As和FU-As。切勿使用STAP-B，MTAP和FU-B。NAL单元的传输顺序必须符合NAL单元的解码顺序。

## 6.4 交错模式

应该支持该模式。它主要用于低延迟应用。在这种模式下，只能使用单个NAL单元数据包，STAP-As和FU-As。切勿使用STAP-B，MTAP和FU-B。NAL单元的传输顺序必须符合NAL单元的解码顺序。

# 7. 解包过程（Informative）

。。。。。

# 10. 拥塞控制

RTP的拥塞控制应根据RFC3550[4]和任何适用的RTP规范适用；例如FRC3551[16]。如果适用尽力而为服务，则另一个要求是：此有效载荷格式的用户务必监视数据包丢失，以确保数据包丢失率在可接受的参数范围内。如果跨相同网络路径并经历相同网络条件的TCP流将达到在合理时间尺度上测得的平均吞吐量不小于RTP流所达到的平均吞吐量，则认为丢包是可以接受的。通过实现拥塞控制机制以适应传输速率（或订阅分层多播会话的层数），或者如果丢失率过高而安排接收者离开会话，则可以满足此条件。

当使用实时编码时，很容易达到遵守拥塞控制原理所需的比特率适配。但是，当传输预编码的内容时，带宽适应要求以不同的比特率提供同一内容的多个编码表示的可用性，或者在比特流中存在非参考图片或子序列[22]。通常，可以在同一RTP会话中执行不同表示之间的切换。例如，通过采用被称为扩展配置文件的SI/SP切片的概念，或者通过在IDR图片边界处切换流。仅当需要更改不可降级的参数（例如，配置文件/级别ID的配置文件部分）时，才有必要终止并重新启动媒体流。这可以通过使用不同的RTP有效负载类型来实现。

MANE可以遵循第7.3节中建议，并在由于先前的数据包丢失而损坏该数据包流时，从该数据包流中删除某些不可用的数据包。在某些特殊情况下，这可以帮助减少网络负载。

# 12.信息性附录：应用实例

该有效负载规范在使用中非常灵活，以涵盖H264预期的极其广泛的应用空间。但是，这种极大的灵活性也使实现者难以决定合理的打包方案。有关如何将此规范应用于实际场景的一些信息可能会在不久的将来以学术出版物，测试模型软件和说明的形式出现。但是这里也介绍了一些初步的使用方案。

## 12.1 符合ITU-T H241建议书的视频电话 附A

## 12.2 视频电话，无切片数据分区，无NAL单元聚合

该方案的RTP部分已实现和测试（尽管不是控制协议部分；参见下文）。

在大多数现实世界的视频电话应用程序中，图片参数（例如图片大小或可选模式）在连接的生命周期内永远不会改变。因此，例如根据本文档第8.2节中指定的SDP语法，发送所有必要的参数集（通常仅一个）作为能力交换/通告过程的副作用。由于在RTP会话开始之前已建立了所有必要的参数集信息，因此无需发送任何参数集NAL单元。也不使用切片数据分区。因此，RTP分组流基本上由携带单个编码切片的NAL单元组成。

编码器选择编码切片NAL单元的大小，以便它们提供最佳性能。通常，这是通过使编码的切片大小适应IP网络的MTU大小来完成的。对于小图片，这可能会导致每包一个图片的策略。帧内刷新算法可以清除数据包的丢失以及由此产生的与漂移相关的伪像。